<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hermometer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #e5e5e5; /* Lighter gray background */
            padding: 20px;
        }
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap');

        .iphone-container {
            width: 375px;
            height: 812px; 
            background-color: #F9F6F2; /* Soft cream background */
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 0 8px #1c1c1c;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .app-screen { 
            flex-grow: 1;
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            padding: 24px; 
            box-sizing: border-box;
            color: #363434; /* Charcoal text */
        }
        #mainScreen.app-screen {
             padding: 0; 
        }

        .app-screen::-webkit-scrollbar { width: 6px; }
        .app-screen::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
        .app-screen::-webkit-scrollbar-track { background-color: transparent; }
        
        .main-content-area { 
            flex-grow: 1;
            padding: 16px; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }
        .main-content-area::-webkit-scrollbar { width: 4px; }
        .main-content-area::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 2px; }

        .app-header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem; 
        }
        #appIconDisplay {
            width: 28px; 
            height: 28px;
            margin-right: 8px; 
        }
        #appIconDisplay svg {
            width: 100%;
            height: 100%;
        }

        input[type="date"], input[type="text"], select, input[type="color"] {
            background-color: #FFF; border: 1px solid #e2e8f0;
            padding: 0.65rem 0.75rem; border-radius: 0.5rem; /* More rounded */
            color: #363434; width: 100%;
            box-sizing: border-box; 
            transition: box-shadow 0.2s;
        }
        input:focus, select:focus {
            box-shadow: 0 0 0 2px #A594F9; /* Focus ring with accent color */
            outline: none;
        }
        input[type="color"] { padding: 0.25rem; height: 2.5rem; }
        input[type="date"] { appearance: none; -webkit-appearance: none; position: relative; }
        input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.6; cursor: pointer; }
        input[type="date"]:invalid::-webkit-datetime-edit { color: #94a3b8; }
        select {
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; 
        }
        
        /* Card style for content blocks */
        .card {
            background-color: #FFFFFF;
            border-radius: 1rem;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 12px;
        }

        .slider-container { position: relative; margin-bottom: 0.5rem; }
        .slider-highlight-track {
            position: absolute;
            top: -8px; 
            left: 10px; 
            right: 10px; 
            height: 6px;
            pointer-events: none; 
            display: flex;
        }
        .highlight-marker {
            position: absolute;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.5); 
            border-radius: 3px;
        }

        input[type="range"] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 6px; /* Thinner */
            background: #e2e8f0; border-radius: 3px; outline: none; opacity: 0.8; transition: opacity .2s;
            margin-top: 10px; 
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 22px; height: 22px; /* Slightly larger thumb */
            background: #7E6AF0; /* Main accent purple */
            border-radius: 50%; cursor: pointer;
            border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mood-visuals-container { display: flex; justify-content: space-around; align-items: center; margin-bottom: 0.75rem; }
        .mood-visual-item { width: 72px; height: 72px; display: flex; justify-content: center; align-items: center; }
        .mood-visual-item svg { max-width: 100%; max-height: 100%; }
        .stylized-face-icon svg { border: none; border-radius: 0.5rem; background-color: transparent; }

        #avatarPreviewSetup { width: 80px; height: 80px; margin: 10px auto; border: 1px solid #d1d1d1; border-radius: 0.75rem; background-color: #f1f1f1; display: flex; justify-content: center; align-items: center; }
        #avatarPreviewSetup svg { width: 100%; height: 100%; }

        .small-thermometer-icon { width: 24px; height: 60px; border: 2px solid #9ca3af; border-radius: 12px 12px 5px 5px; position: relative; background-color: #f8fafc; }
        .small-thermometer-bulb { width: 12px; height: 12px; background-color: #ef4444; border-radius: 50%; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); }
        .small-thermometer-fill { width: 8px; background-color: #ef4444; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); border-radius: 4px 4px 0 0; transition: height 0.3s ease, background-color 0.3s ease; height: 0%; }

        /* New Refined Color Palette */
        .menstruation-text { color: #6A7FDB; } .menstruation-bg { background-color: #EAEFFF; } 
        .follicular-text { color: #50A288; } .follicular-bg { background-color: #E4F5EF; }
        .late-follicular-text { color: #5AB2A6; } .late-follicular-bg { background-color: #E6F7F5; } 
        .ovulation-text { color: #E37C99; } .ovulation-bg { background-color: #FCEFF3; }
        .early-luteal-text { color: #58A4B0; } .early-luteal-bg { background-color: #E6F5F7; }
        .mid-luteal-text { color: #D98E61; } .mid-luteal-bg { background-color: #FBEFDF; }
        .late-luteal-text { color: #C97A58; } .late-luteal-bg { background-color: #F9EBE5; }
        .default-text { color: #64748b; } .default-bg { background-color: #f1f5f9; } 

        .btn-primary { background-color: #7E6AF0; color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; text-align: center; cursor: pointer; transition: background-color 0.2s; box-shadow: 0 2px 8px rgba(126, 106, 240, 0.3); }
        .btn-primary:hover { background-color: #6954e0; }
        .btn-danger { background-color: #EF4444; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; text-align: center; cursor: pointer; transition: background-color 0.2s; font-size: 0.8rem; }
        .btn-danger:hover { background-color: #DC2626; }
        .btn-secondary { background-color: #8B5CF6; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; text-align: center; cursor: pointer; transition: background-color 0.2s; font-size: 0.8rem; margin-top: 8px; }
        .btn-secondary:hover { background-color: #7C3AED; }
        
        .hidden { display: none !important; } 

        .graph-legend { display: flex; justify-content: center; gap: 12px; font-size: 0.75rem; margin-bottom: 8px; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-color-box { width: 10px; height: 10px; border-radius: 2px; }
        #recommendationText { font-size: 0.85rem; color: #363434; line-height: 1.6; text-align: left; padding: 0 4px; position: relative; min-height: 40px; }
        .user-info-header { text-align: center; margin-bottom: 8px; color: #363434; }
        .user-info-header p { font-size: 0.9rem; line-height: 1.4; }
        .user-info-header .user-name { font-weight: 600; font-size: 1rem; }
        .setup-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .span-col-2 { grid-column: span 2 / span 2; }
        .suggestion-checkboxes { margin-top: 0.75rem; margin-bottom: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .suggestion-checkboxes label { display: flex; align-items: center; font-size: 0.8rem; color: #374151; cursor: pointer; }
        .suggestion-checkboxes input[type="checkbox"] { margin-right: 0.5rem; height: 1rem; width: 1rem; accent-color: #7E6AF0; }

        /* Welcome Screen Styles */
        #welcomeArtwork { width: 150px; height: 150px; margin: 2rem auto; }
        #welcomeScreen .welcome-text { color: #52525B; line-height: 1.6; font-size: 0.95rem; text-align: center; }
        #welcomeScreen .welcome-text p { margin-bottom: 1rem; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 20px; border-radius: 1rem; width: 90%; max-width: 340px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .modal-content p { margin-bottom: 16px; font-size: 1rem; color: #334155; }

    </style>
</head>
<body>
    <div class="iphone-container">
        <div id="welcomeScreen" class="app-screen hidden">
            <header class="text-center mb-2">
                 <h1 class="text-3xl font-bold text-slate-800">Welcome to Hermometer</h1>
            </header>
            <div id="welcomeArtwork"></div>
            <div class="welcome-text flex-grow">
                <p>The menstrual cycle can feel like unfamiliar territory. But if you’re here, it means you care, and that’s a great start.</p>
                <p>Hermometer is here to help you understand the shifts in mood, energy, and emotions your partner may experience throughout her cycle. It’s not about stereotypes. It’s about empathy, timing, and being more in sync.</p>
                <p>This app isn’t medical advice, but it is a tool for connection, insight, and maybe a few laughs along the way.</p>
            </div>
            <button id="proceedToSetupBtn" class="btn-primary w-full mt-4">Ready? Let’s go.</button>
        </div>

        <div id="setupScreen" class="app-screen hidden"> 
            <header class="text-center mb-6">
                <h1 class="text-2xl font-bold">Let's capture some details about your better half...</h1>
                <p class="text-sm text-slate-500 mt-2">This helps personalize the experience.</p>
            </header>
            <section class="space-y-4 flex-grow">
                <div class="span-col-2">
                    <label for="partnerName" class="block text-xs font-medium text-slate-700 mb-1">Her Name</label>
                    <input type="text" id="partnerName" name="partnerName" placeholder="E.g., Sarah">
                </div>
                <div class="span-col-2">
                    <label for="lmpDateSetup" class="block text-xs font-medium text-slate-700 mb-1">Her Last Menstruation Date (1st day)</label>
                    <input type="date" id="lmpDateSetup" name="lmpDateSetup">
                </div>
                
                <h2 class="text-lg font-semibold text-slate-700 mt-4 pt-2 border-t border-slate-200 span-col-2">Avatar Customization</h2>
                <p class="text-xs text-slate-500 span-col-2 -mt-3 mb-2 text-center">You might want to make this closer to how she looks, but it's not essential.</p>
                <div id="avatarPreviewSetup"><svg viewBox="0 0 24 24"></svg></div> 
                <div class="setup-grid">
                    <div>
                        <label for="faceShape" class="block text-xs font-medium text-slate-700 mb-1">Face Shape</label>
                        <select id="faceShape" name="faceShape">
                            <option value="oval">Oval</option>
                            <option value="round">Round</option>
                            <option value="square">Square</option>
                        </select>
                    </div>
                    <div>
                        <label for="skinTone" class="block text-xs font-medium text-slate-700 mb-1">Skin Tone</label>
                        <input type="color" id="skinTone" name="skinTone" value="#F0C0A0">
                    </div>
                     <div>
                        <label for="eyeColor" class="block text-xs font-medium text-slate-700 mb-1">Eye Color</label>
                        <input type="color" id="eyeColor" name="eyeColor" value="#5080C0">
                    </div>
                    <div>
                        <label for="eyeShape" class="block text-xs font-medium text-slate-700 mb-1">Eye Shape</label>
                        <select id="eyeShape" name="eyeShape">
                            <option value="almond">Almond</option>
                            <option value="round_eyes">Round</option>
                            <option value="upturned">Upturned</option>
                        </select>
                    </div>
                    <div class="span-col-2">
                        <label for="lipShape" class="block text-xs font-medium text-slate-700 mb-1">Lip Shape</label>
                         <select id="lipShape" name="lipShape">
                            <option value="natural">Natural</option>
                            <option value="full_lips">Full</option>
                            <option value="thin_lips">Thin</option>
                        </select>
                    </div>
                </div>

                <button id="startTrackingBtn" class="btn-primary w-full mt-4 span-col-2">Save & Continue</button>
            </section>
             <footer class="text-center mt-auto pt-4">
                <button id="resetAppBtn" class="text-sm text-gray-500 hover:text-red-600 underline">Start Over & Reset App</button>
             </footer>
        </div>

        <div id="mainScreen" class="app-screen hidden">
            <div class="main-content-area">
                <header class="app-header-container"> 
                    <div id="appIconDisplay"></div>
                    <h1 class="text-2xl font-bold">Hermometer</h1> 
                </header>
                <div id="userInfoHeader" class="user-info-header"></div>
                <section class="card space-y-3"> 
                    <div>
                        <label for="outlookDateSlider" class="block text-sm font-medium mb-1">Outlook for Date:</label>
                        <div class="slider-container">
                            <div id="sliderHighlightTrack" class="slider-highlight-track"></div>
                            <input type="range" id="outlookDateSlider" name="outlookDateSlider" min="0" max="60" value="0">
                        </div>
                        <div id="outlookDateDisplay" class="text-sm text-slate-500 text-center">Today</div>
                    </div>
                    <div id="suggestionCheckboxesContainer" class="suggestion-checkboxes hidden"> 
                        <label id="dinnerDateLabel"><input type="checkbox" id="dinnerDateCheckbox"> Suggest: Best for a date night</label>
                        <label id="bizTripLabel"><input type="checkbox" id="bizTripCheckbox"> Consider: I'll be leaving for a business trip</label>
                        <label><input type="checkbox" id="lazySundaysCheckbox"> Support: I love lazy Sundays</label>
                    </div>
                </section>
                <section id="output-section" class="card text-center p-3"> 
                    <div class="mood-visuals-container">
                        <div id="smallThermometerDisplay" class="mood-visual-item"></div>
                        <div id="avatarDisplay" class="mood-visual-item stylized-face-icon"></div>
                        <div id="phaseIconDisplay" class="mood-visual-item"></div>
                    </div>
                    <div id="moodTextDisplay"></div>
                </section>
                
                <section id="recommendationSection" class="card">
                    <div class="flex justify-between items-center mb-2">
                        <label for="mainSuggestionTone" class="block text-sm font-medium">Suggestion Tone:</label>
                        <select id="mainSuggestionTone" name="mainSuggestionTone" class="w-1/2 text-sm p-1 rounded-md">
                            <option value="easygoing">Easygoing</option>
                            <option value="scientific">Scientific</option>
                            <option value="dude_mode">Dude Mode</option>
                        </select>
                    </div>
                    <div id="recommendationText"></div>
                     <button id="getDateIdeaBtn" class="btn-secondary w-full mt-3">✨ Get a Date Idea</button>
                </section>
                <section id="hormoneGraphContainer" class="card">
                    <h3>Hormone Levels Overview</h3>
                    <div class="graph-legend">
                        <span class="legend-item"><span class="legend-color-box" style="background-color: #E37C99;"></span>Estrogen</span>
                        <span class="legend-item"><span class="legend-color-box" style="background-color: #58A4B0;"></span>Progesterone</span>
                        <span class="legend-item"><span class="legend-color-box" style="background-color: #A594F9;"></span>Testosterone</span>
                    </div>
                    <svg id="hormoneChart" width="100%" height="120" viewBox="0 0 300 120"></svg>
                </section>
                <footer class="text-center mt-auto pt-2">
                     <button id="resetSetupBtn" class="text-sm text-gray-500 hover:text-gray-800 underline mb-1">Settings & Avatar</button>
                    <p class="text-xs text-gray-400">Disclaimer: Generalized info.</p>
                </footer>
            </div>
        </div>

        <div id="dateIdeaModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">Date Night Idea!</h3>
                <div id="dateIdeaText"></div>
                <button id="closeDateIdeaModal" class="btn-primary mt-4">Got it!</button>
            </div>
        </div>
        
        <div id="confirmResetModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 class="text-lg font-semibold text-slate-800 mb-2">Reset App?</h3>
                <p id="confirmResetText" class="text-sm text-gray-600 mb-4">Are you sure you want to reset all your data? This cannot be undone.</p>
                <div class="flex justify-around">
                    <button id="cancelResetBtn" class="btn-primary" style="background-color: #64748B;">Cancel</button>
                    <button id="confirmResetBtn" class="btn-danger">Yes, Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const setupScreen = document.getElementById('setupScreen');
        const mainScreen = document.getElementById('mainScreen');
        const proceedToSetupBtn = document.getElementById('proceedToSetupBtn');
        const partnerNameInput = document.getElementById('partnerName');
        const lmpDateSetupInput = document.getElementById('lmpDateSetup');
        const mainSuggestionToneSelect = document.getElementById('mainSuggestionTone'); 
        const startTrackingBtn = document.getElementById('startTrackingBtn');
        const resetSetupBtn = document.getElementById('resetSetupBtn');
        const resetAppBtn = document.getElementById('resetAppBtn');
        const userInfoHeaderDiv = document.getElementById('userInfoHeader');
        const appIconDisplay = document.getElementById('appIconDisplay'); 
        const welcomeArtwork = document.getElementById('welcomeArtwork');
        
        const avatarPreviewSetupDiv = document.getElementById('avatarPreviewSetup');
        const faceShapeSelect = document.getElementById('faceShape');
        const skinToneInput = document.getElementById('skinTone');
        const eyeColorInput = document.getElementById('eyeColor');
        const eyeShapeSelect = document.getElementById('eyeShape');
        const lipShapeSelect = document.getElementById('lipShape');

        const outlookDateSlider = document.getElementById('outlookDateSlider');
        const outlookDateDisplay = document.getElementById('outlookDateDisplay');
        const sliderHighlightTrack = document.getElementById('sliderHighlightTrack'); 
        const suggestionCheckboxesContainer = document.getElementById('suggestionCheckboxesContainer'); 
        const dinnerDateCheckbox = document.getElementById('dinnerDateCheckbox');
        const bizTripCheckbox = document.getElementById('bizTripCheckbox');
        const lazySundaysCheckbox = document.getElementById('lazySundaysCheckbox');
        
        const outputSection = document.getElementById('output-section');
        const smallThermometerDisplay = document.getElementById('smallThermometerDisplay');
        const avatarDisplay = document.getElementById('avatarDisplay');
        const phaseIconDisplay = document.getElementById('phaseIconDisplay');
        const moodTextDisplay = document.getElementById('moodTextDisplay');
        
        const hormoneChartSVG = document.getElementById('hormoneChart');
        const recommendationTextDiv = document.getElementById('recommendationText');
        const getDateIdeaBtn = document.getElementById('getDateIdeaBtn');
        const dateIdeaModal = document.getElementById('dateIdeaModal');
        const dateIdeaText = document.getElementById('dateIdeaText');
        const closeDateIdeaModal = document.getElementById('closeDateIdeaModal');
        
        const confirmResetModal = document.getElementById('confirmResetModal');
        const cancelResetBtn = document.getElementById('cancelResetBtn');
        const confirmResetBtn = document.getElementById('confirmResetBtn');

        let currentPartnerName = "User";
        let currentLmpDate = null;
        let currentSuggestionTone = "easygoing";
        
        const empathyWaveIconSVG = `
            <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs><linearGradient id="waveGrad" x1="0%" y1="50%" x2="100%" y2="50%"><stop offset="0%" style="stop-color:#6A7FDB;" /><stop offset="50%" style="stop-color:#E37C99;" /><stop offset="100%" style="stop-color:#D98E61;" /></linearGradient></defs>
                <path d="M14 22.4C10.6 19.5 8 17.2 8 14C8 11.2 10.1 9 12.5 9C14.1 9 15.6 9.9 16.5 11.3L17.5 9.9C18.4 8.5 19.9 7.6 21.5 7.6C23.9 7.6 26 9.8 26 12.6C26 15.8 23.4 18.1 20 21L14 26L8 21C4.6 18.1 2 15.8 2 12.6C2 9.8 4.1 7.6 6.5 7.6C8.1 7.6 9.6 8.5 10.5 9.9L11.5 11.3C12.4 9.9 13.9 9 15.5 9C17.9 9 20 11.2 20 14C20 17.2 17.4 19.5 14 22.4Z" fill="#D1D5DB" fill-opacity="0.5"/>
                <path d="M2 14.5 Q8 17.5 14 14.5 T26 14.5" stroke="url(#waveGrad)" stroke-width="2.5" fill="none" stroke-linecap="round"/>
            </svg>`;

        const welcomeArtworkSVG = `
            <svg viewBox="0 0 100 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs><linearGradient id="artWaveGrad" x1="0%" y1="50%" x2="100%" y2="50%"><stop offset="0%" style="stop-color:#6A7FDB;" /><stop offset="50%" style="stop-color:#E37C99;" /><stop offset="100%" style="stop-color:#D98E61;" /></linearGradient></defs>
                <path d="M75 75 C 65 78 50 70 50 55 C 50 35 65 25 78 22 C 90 19 98 30 95 45 C 92 60 85 72 75 75 Z" fill="#D1D5DB" opacity="0.4"/>
                <path d="M25 78 C 35 81 50 73 50 58 C 50 38 35 28 22 25 C 10 22 2 33 5 48 C 8 63 15 75 25 78 Z" fill="#363434" opacity="0.9"/>
                <path d="M60 55 Q70 60 80 55 T90 58" stroke="url(#artWaveGrad)" stroke-width="3" fill="none" stroke-linecap="round"/>
            </svg>`;
        
        let currentAvatarConfig = {
            faceShape: 'oval', skinTone: '#F0C0A0',
            eyeColor: '#5080C0', eyeShape: 'almond',
            lipShape: 'natural'
        };

        const aiGeneratedResponses = {
            dude_mode: {
                menstruation: ["Red flag week. She's basically a bear with a sore head. Keep chocolate supplies high, complaints low, and maybe offer to do the dishes without being asked. Survival mode: ON."],
                follicular: ["The storm has passed, sun's peeking out. She's probably in a decent mood. Don't mess it up. Maybe even suggest doing something *she* likes for a change."],
                'late-follicular': ["Energy is ramping up for the main event. Good time to make plans for the weekend. Just be agreeable."],
                ovulation: ["Alright, Casanova, this is your green light. She's biologically programmed to be more receptive. Send that flirty text. You know the drill... or you should by now. Go time!"],
                'early-luteal': ["Coast is relatively clear. Don't rock the boat. She's not peak-flirty, but probably not plotting your demise either. Maintain status quo, soldier."],
                'mid-luteal': ["The tides are turning, my friend. Proceed with caution. Any sudden moves could be met with unexpected turbulence."],
                'late-luteal': ["Danger Zone! PMS approaching. Think of it like navigating a minefield in clown shoes. Avoid sudden movements, controversial topics, and for the love of all that's holy, don't ask 'Are you on your period?'. Just... be less annoying."],
                default: ["When in doubt, assume nothing and maybe bring snacks. Can't go too wrong with snacks."]
            },
            dateIdeas: {
                menstruation: ["How about a cozy movie night in with all her favorite snacks and a warm blanket?", "A quiet, relaxing evening at home with takeout from her favorite restaurant sounds perfect.", "Let's build a pillow fort and binge-watch a new series together."],
                follicular: ["Let's try that new restaurant or food truck we've been talking about.", "A scenic hike or a long walk somewhere beautiful would be great for this energy level.", "How about we tackle a fun project together, like painting that bookshelf?"],
                'late-follicular': ["Let's go out dancing or to a place with live music and lots of energy.", "A spontaneous trip to a nearby town for the day could be a fun adventure.", "How about we host a small get-together with our closest friends this weekend?"],
                ovulation: ["A fancy dinner date at that place you love, just the two of us.", "Let's hit up a fun social event, like an art opening or a street festival.", "A romantic evening walk followed by drinks at a rooftop bar would be amazing."],
                'early-luteal': ["How about a relaxed picnic in the park with a good book and some wine?", "A chill night of cooking a nice meal together sounds perfect.", "Let's visit a quiet museum or art gallery we haven't been to yet."],
                'mid-luteal': ["A relaxing at-home spa night with face masks and a chill playlist is a great bet.", "Watch a comforting, nostalgic movie from her childhood.", "Let's just order a pizza and enjoy a quiet, easy evening together."],
                'late-luteal': ["Let's have a super-chill movie marathon with all the best comfort food.", "How about I take care of everything tonight so you can just relax?", "A quiet evening with a good book and a cup of tea sounds like the perfect plan."],
                default: ["How about we just order some food and watch a movie?"]
            }
        };

        const cyclePhaseIcons = { /* ... (same as before) ... */ 
            menstruation: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.93 11.93a9 9 0 0 0-17.86 0"></path><path d="M12 2v4"></path><path d="M12 18v4"></path><path d="M4.93 4.93l2.83 2.83"></path><path d="M16.24 16.24l2.83 2.83"></path><path d="M2 12h4"></path><path d="M18 12h4"></path><path d="M4.93 19.07l2.83-2.83"></path><path d="M16.24 7.76l2.83-2.83"></path><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.3"></circle></svg>`,
            follicular: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 0 0-10 10c0 3.34 1.64 6.35 4.22 8.22"></path><path d="M12 22a10 10 0 0 0 10-10c0-3.34-1.64-6.35-4.22-8.22"></path><path d="M12 6v12"></path><path d="M16 10l-4 4-4-4"></path></svg>`,
            ovulation: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>`,
            'early-luteal': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22A10 10 0 1 1 12 2a10 10 0 0 1 0 20z"></path><path d="M12 8v8"></path><path d="M8.5 14.5L12 11l3.5 3.5"></path></svg>`,
            'late-luteal': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
            default: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>`
        };
        function getFaceSVG(config, mood) { /* ... (same as before, no hair) ... */ 
            const { faceShape, skinTone, eyeColor, eyeShape, lipShape } = config;
            const { eyeType, mouthType, eyebrowType } = mood; 
            let facePath = ''; let faceYOffset = 0;
            switch (faceShape) {
                case 'round': facePath = `<circle cx="12" cy="${12 + faceYOffset}" r="9.5" fill="${skinTone}" stroke="${skinTone}" stroke-width="0.5"/>`; break;
                case 'square': facePath = `<rect x="2.5" y="${2.5 + faceYOffset}" width="19" height="19" rx="2" fill="${skinTone}" stroke="${skinTone}" stroke-width="0.5"/>`; break;
                case 'oval': default: facePath = `<ellipse cx="12" cy="12.5" rx="8" ry="9.5" fill="${skinTone}" stroke="${skinTone}" stroke-width="0.5"/>`; break;
            }
            let baseEyes = ''; const eyeY = 10.5; 
            switch(eyeShape) {
                case 'round_eyes': baseEyes = `<circle cx="8.5" cy="${eyeY}" r="2" fill="${eyeColor}"/><circle cx="15.5" cy="${eyeY}" r="2" fill="${eyeColor}"/>`; break;
                case 'upturned': baseEyes = `<ellipse cx="8.5" cy="${eyeY}" rx="2.3" ry="1.7" transform="rotate(-15 8.5 ${eyeY})" fill="${eyeColor}"/> <ellipse cx="15.5" cy="${eyeY}" rx="2.3" ry="1.7" transform="rotate(-15 15.5 ${eyeY})" fill="${eyeColor}"/>`; break;
                case 'almond': default: baseEyes = `<ellipse cx="8.5" cy="${eyeY}" rx="2.4" ry="1.7" fill="${eyeColor}"/><ellipse cx="15.5" cy="${eyeY}" rx="2.4" ry="1.7" fill="${eyeColor}"/>`; break;
            }
            let moodEyeOverlay = ''; const pupilColor = "#111827"; 
            switch(eyeType) {
                case 'sleepy': moodEyeOverlay = `<path d="M6 ${eyeY-0.5} Q8.5 ${eyeY-1.5} 11 ${eyeY-0.5} M13 ${eyeY-0.5} Q15.5 ${eyeY-1.5} 18 ${eyeY-0.5}" stroke="${skinTone}" stroke-width="3" fill="none"/>`; break; 
                case 'sparkle': moodEyeOverlay = `<circle cx="8" cy="${eyeY-0.5}" r="0.6" fill="white" opacity="0.9"/><circle cx="15" cy="${eyeY-0.5}" r="0.6" fill="white" opacity="0.9"/>`; break; 
                case 'sensitive': moodEyeOverlay = `<path d="M7 ${eyeY+1.2} Q8.5 ${eyeY+0.5} 10 ${eyeY+1.2} M14 ${eyeY+1.2} Q15.5 ${eyeY+0.5} 17 ${eyeY+1.2}" stroke="${skinTone}" stroke-width="1.5" fill="none"/>`; break; 
                default: moodEyeOverlay = `<circle cx="8.5" cy="${eyeY}" r="0.9" fill="${pupilColor}"/><circle cx="15.5" cy="${eyeY}" r="0.9" fill="${pupilColor}"/>`; 
            }
            let lipPath = ''; const lipY = 17; const lipColor = mood.lipColor || "#E58C93"; 
            switch(lipShape) {
                case 'full_lips': lipPath = `<path d="M8 ${lipY-0.8} Q12 ${lipY+1.2} 16 ${lipY-0.8} M8 ${lipY-0.8} Q12 ${lipY-1.8} 16 ${lipY-0.8} Z" fill="${lipColor}" />`; break;
                case 'thin_lips': lipPath = `<line x1="8.5" y1="${lipY}" x2="15.5" y2="${lipY}" stroke="${lipColor}" stroke-width="1.5"/>`; break;
                case 'natural': default: lipPath = `<path d="M8.5 ${lipY} Q12 ${lipY+0.6} 15.5 ${lipY} M8.5 ${lipY} Q12 ${lipY-0.6} 15.5 ${lipY} Z" fill="${lipColor}" />`; break;
            }
            let moodMouthOverlay = ''; const expressionColor = mood.expressionLineColor || "#4B5563"; 
             switch(mouthType) {
                case 'smile': moodMouthOverlay = `<path d="M8.5 ${lipY-0.2} Q12 ${lipY+1.5} 15.5 ${lipY-0.2}" stroke="${expressionColor}" stroke-width="1.2" fill="none"/>`; break;
                case 'flirty': moodMouthOverlay = `<path d="M8.5 ${lipY} Q10 ${lipY+0.8} 12 ${lipY} Q14 ${lipY-0.8} 15.5 ${lipY}" stroke="${expressionColor}" stroke-width="1.2" fill="none"/>`; break;
                case 'sad': moodMouthOverlay = `<path d="M8.5 ${lipY+0.8} Q12 ${lipY-0.5} 15.5 ${lipY+0.8}" stroke="${expressionColor}" stroke-width="1.2" fill="none"/>`; break;
                case 'neutral': default: moodMouthOverlay = lipPath; break; 
            }
            if (mouthType !== 'neutral') lipPath = ''; 
            let eyebrowPath = ''; const eyebrowY = eyeY - 3; const eyebrowColor = "#5B3A29"; 
            switch(eyebrowType) {
                case 'raised': eyebrowPath = `<path d="M6 ${eyebrowY-0.8} Q8.5 ${eyebrowY-2} 11 ${eyebrowY-0.8} M13 ${eyebrowY-0.8} Q15.5 ${eyebrowY-2} 18 ${eyebrowY-0.8}" stroke="${eyebrowColor}" stroke-width="1.5" fill="none"/>`; break;
                case 'furrowed': eyebrowPath = `<path d="M7.5 ${eyebrowY+0.5} Q9 ${eyebrowY-0.8} 10.5 ${eyebrowY+0.5} M13.5 ${eyebrowY+0.5} Q15 ${eyebrowY-0.8} 16.5 ${eyebrowY+0.5}" stroke="${eyebrowColor}" stroke-width="1.5" fill="none"/>`; break;
                case 'normal': default: eyebrowPath = `<path d="M6.5 ${eyebrowY} Q8.5 ${eyebrowY-1.2} 10.5 ${eyebrowY} M13.5 ${eyebrowY} Q15.5 ${eyebrowY-1.2} 17.5 ${eyebrowY}" stroke="${eyebrowColor}" stroke-width="1.5" fill="none"/>`; break;
            }
            return `<svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">${facePath}${baseEyes}${moodEyeOverlay}${eyebrowPath}${lipPath}${moodMouthOverlay}</svg>`;
        }
        
        function formatDate(date) { return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }); }
        function addDays(date, days) { const result = new Date(date); result.setDate(result.getDate() + days); return result; }

        const graphWidth = 300; const graphHeight = 100; 
        const graphPadding = { top: 15, right: 10, bottom: 20, left: 25 };

        function drawHormoneGraphBase() { 
            hormoneChartSVG.innerHTML = ''; const chartAreaWidth = graphWidth - graphPadding.left - graphPadding.right; const chartAreaHeight = graphHeight - graphPadding.top - graphPadding.bottom;
            const xAxisLine = document.createElementNS("http://www.w3.org/2000/svg", "line"); xAxisLine.setAttribute("x1", graphPadding.left); xAxisLine.setAttribute("y1", graphHeight - graphPadding.bottom); xAxisLine.setAttribute("x2", graphWidth - graphPadding.right); xAxisLine.setAttribute("y2", graphHeight - graphPadding.bottom); xAxisLine.setAttribute("stroke", "#e5e7eb"); hormoneChartSVG.appendChild(xAxisLine);
            for (let i = 0; i <= 28; i += 7) { const tickX = graphPadding.left + (i / 28) * chartAreaWidth; const tick = document.createElementNS("http://www.w3.org/2000/svg", "line"); tick.setAttribute("x1", tickX); tick.setAttribute("y1", graphHeight - graphPadding.bottom); tick.setAttribute("x2", tickX); tick.setAttribute("y2", graphHeight - graphPadding.bottom + 4); tick.setAttribute("stroke", "#94a3b8"); hormoneChartSVG.appendChild(tick); if (i % 7 === 0) { const label = document.createElementNS("http://www.w3.org/2000/svg", "text"); label.setAttribute("x", tickX); label.setAttribute("y", graphHeight - graphPadding.bottom + 14); label.setAttribute("text-anchor", "middle"); label.setAttribute("font-size", "8px"); label.setAttribute("fill", "#64748b"); label.textContent = i === 0 ? "1" : i; hormoneChartSVG.appendChild(label); } }
            const scaleX = (day) => graphPadding.left + ((day - 1) / 27) * chartAreaWidth; const scaleY = (level) => graphHeight - graphPadding.bottom - (level / 100) * chartAreaHeight;
            const estrogenData = [[1,10],[5,15],[7,25],[10,60],[12,85],[13,90],[14,70],[16,40],[20,50],[22,55],[24,45],[26,20],[28,10]]; const progesteroneData = [[1,5],[7,5],[13,10],[15,15],[18,50],[21,80],[23,70],[25,40],[28,5]]; const testosteroneData = [[1,10],[7,12],[12,20],[14,25],[16,20],[21,15],[28,10]];
            function createPathFromData(data, color) { if (data.length < 2) return; let pathData = `M ${scaleX(data[0][0])} ${scaleY(data[0][1])}`; for (let i = 1; i < data.length; i++) { const prevX = scaleX(data[i-1][0]); const prevY = scaleY(data[i-1][1]); const currX = scaleX(data[i][0]); const currY = scaleY(data[i][1]); const cp1X = prevX + (currX - prevX) / 2; const cp1Y = prevY; const cp2X = prevX + (currX - prevX) / 2; const cp2Y = currY; pathData += ` C ${cp1X} ${cp1Y}, ${cp2X} ${cp2Y}, ${currX} ${currY}`; } const path = document.createElementNS("http://www.w3.org/2000/svg", "path"); path.setAttribute("d", pathData); path.setAttribute("stroke", color); path.setAttribute("stroke-width", "2.5"); path.setAttribute("fill", "none"); path.setAttribute("stroke-linecap", "round"); path.setAttribute("stroke-linejoin", "round"); hormoneChartSVG.appendChild(path); }
            createPathFromData(estrogenData, "#E37C99"); createPathFromData(progesteroneData, "#58A4B0"); createPathFromData(testosteroneData, "#A594F9");
            const indicatorLine = document.createElementNS("http://www.w3.org/2000/svg", "line"); indicatorLine.setAttribute("id", "graphIndicator"); indicatorLine.setAttribute("y1", graphPadding.top); indicatorLine.setAttribute("y2", graphHeight - graphPadding.bottom); indicatorLine.setAttribute("stroke", "#363434"); indicatorLine.setAttribute("stroke-width", "1.5"); indicatorLine.setAttribute("stroke-dasharray", "2,2"); hormoneChartSVG.appendChild(indicatorLine);
        }
        function updateGraphIndicator(cycleDay) { 
            const indicator = document.getElementById('graphIndicator'); if (!indicator) return; const chartAreaWidth = graphWidth - graphPadding.left - graphPadding.right; const dayRatio = (cycleDay - 1) / 27; const xPos = graphPadding.left + dayRatio * chartAreaWidth; indicator.setAttribute("x1", xPos); indicator.setAttribute("x2", xPos);
        }
        
        function updateSmallThermometerVisual(phaseClassKey, cycleDay) {
            const thermometerIcon = `<div class="small-thermometer-icon"><div class="small-thermometer-fill"></div><div class="small-thermometer-bulb"></div></div>`;
            smallThermometerDisplay.innerHTML = thermometerIcon; 

            const fillElement = smallThermometerDisplay.querySelector('.small-thermometer-fill');
            const bulbElement = smallThermometerDisplay.querySelector('.small-thermometer-bulb');
            if (!fillElement || !bulbElement) return;

            let fillPercent = 10; 
            const colorMap = { 'menstruation': '#6A7FDB', 'follicular': '#50A288', 'late-follicular': '#5AB2A6', 'ovulation': '#E37C99', 'early-luteal': '#58A4B0', 'mid-luteal': '#D98E61', 'late-luteal': '#C97A58', 'default': '#9ca3af' };
            const actualColor = colorMap[phaseClassKey] || '#9ca3af';

            if (phaseClassKey === 'menstruation') { fillPercent = 15; 
            } else if (phaseClassKey === 'follicular') { fillPercent = 35; 
            } else if (phaseClassKey === 'late-follicular') { fillPercent = 60;
            } else if (phaseClassKey === 'ovulation') { fillPercent = 90; 
            } else if (phaseClassKey === 'early-luteal') { fillPercent = 70; 
            } else if (phaseClassKey === 'mid-luteal') { fillPercent = 50;
            } else if (phaseClassKey === 'late-luteal') { fillPercent = 25; }
            
            fillPercent = Math.max(5, Math.min(65, fillPercent)); 
            
            fillElement.style.height = `${fillPercent}%`;
            fillElement.style.backgroundColor = actualColor;
            bulbElement.style.backgroundColor = actualColor;
        }

        const staticRecommendations = {
            menstruation: {
                scientific: "Estrogen and progesterone are at their lowest. This can lead to fatigue and decreased energy. Physiological support and reduced demands are beneficial.",
                easygoing: "She might be feeling tired or need some extra comfort. Offer a cozy blanket, a warm drink, or just some quiet time together. A little TLC goes a long way.",
            },
            follicular: {
                scientific: "Rising estrogen levels typically correlate with increased energy and improved mood. Cognitive functions may also be enhanced during this phase.",
                easygoing: "Energy's on the upswing! Good time to suggest fun activities or tackle that project you've been putting off together. She's likely feeling more positive.",
            },
            'late-follicular': {
                scientific: "Estrogen continues to rise towards its peak, often associated with high energy, confidence, and sociability.",
                easygoing: "Confidence and energy are likely peaking. It's a great time for social events, adventurous dates, or tackling big plans."
            },
            ovulation: {
                scientific: "Peak estrogen and a surge in luteinizing hormone mark ovulation. Libido and sociability may be at their highest. Testosterone also sees a slight increase.",
                easygoing: "This is often when she's feeling her best – energetic, confident, and social. Perfect time for a date night or connecting with friends. Enjoy the great vibe!",
            },
            'early-luteal': {
                scientific: "Progesterone begins to rise, which can have a calming, steadying effect post-ovulation. Estrogen starts to decline.",
                easygoing: "Energy might be settling into a stable, pleasant rhythm. A good time for relaxed, quality connection and conversations.",
            },
            'mid-luteal': {
                scientific: "Progesterone peaks. For some, this brings a sense of calm. For others, this hormonal shift can trigger early PMS symptoms like bloating or moodiness.",
                easygoing: "This can be a mixed bag. Be attentive. It could be a calm day or the start of feeling more sensitive. Check in and see what kind of support she needs.",
            },
            'late-luteal': {
                scientific: "Sharp declines in both estrogen and progesterone can lead to premenstrual symptoms, including mood swings, irritability, and fatigue.",
                easygoing: "This can be a sensitive time. Be extra patient and understanding. Small gestures of kindness mean a lot. Offer support and listen if she needs to vent. Respect the hormones. Send chocolate. Text, don’t call."
            },
            default: {
                scientific: "Individual hormonal profiles and responses vary. Consistent tracking and open communication provide the most reliable insights.",
                easygoing: "Open communication is always key. Ask how she's feeling and how you can be supportive.",
            }
        };

        function getRecommendation(phaseClassKey, tone) {
            
            const aiGeneratedResponses = {
                dude_mode: {
                    menstruation: ["Red flag week. She's basically a bear with a sore head. Keep chocolate supplies high, complaints low, and maybe offer to do the dishes without being asked. Survival mode: ON."],
                    follicular: ["The storm has passed, sun's peeking out. She's probably in a decent mood. Don't mess it up. Maybe even suggest doing something *she* likes for a change."],
                    'late-follicular': ["Energy is ramping up for the main event. Good time to make plans for the weekend. Just be agreeable."],
                    ovulation: ["Alright, Casanova, this is your green light. She's biologically programmed to be more receptive. Send that flirty text. You know the drill... or you should by now. Go time!"],
                    'early-luteal': ["Coast is relatively clear. Don't rock the boat. She's not peak-flirty, but probably not plotting your demise either. Maintain status quo, soldier."],
                    'mid-luteal': ["The tides are turning, my friend. Proceed with caution. Any sudden moves could be met with unexpected turbulence."],
                    'late-luteal': ["Danger Zone! PMS approaching. Think of it like navigating a minefield in clown shoes. Avoid sudden movements, controversial topics, and for the love of all that's holy, don't ask 'Are you on your period?'. Just... be less annoying."],
                    default: ["When in doubt, assume nothing and maybe bring snacks. Can't go too wrong with snacks."]
                },
                dateIdeas: {
                    menstruation: ["How about a cozy movie night in with all her favorite snacks and a warm blanket?", "A quiet, relaxing evening at home with takeout from her favorite restaurant sounds perfect.", "Let's build a pillow fort and binge-watch a new series together."],
                    follicular: ["Let's try that new restaurant or food truck we've been talking about.", "A scenic hike or a long walk somewhere beautiful would be great for this energy level.", "How about we tackle a fun project together, like painting that bookshelf?"],
                    'late-follicular': ["Let's go out dancing or to a place with live music and lots of energy.", "A spontaneous trip to a nearby town for the day could be a fun adventure.", "How about we host a small get-together with our closest friends this weekend?"],
                    ovulation: ["A fancy dinner date at that place you love, just the two of us.", "Let's hit up a fun social event, like an art opening or a street festival.", "A romantic evening walk followed by drinks at a rooftop bar would be amazing."],
                    'early-luteal': ["How about a relaxed picnic in the park with a good book and some wine?", "A chill night of cooking a nice meal together sounds perfect.", "Let's visit a quiet museum or art gallery we haven't been to yet."],
                    'mid-luteal': ["A relaxing at-home spa night with face masks and a chill playlist is a great bet.", "Watch a comforting, nostalgic movie from her childhood.", "Let's just order a pizza and enjoy a quiet, easy evening together."],
                    'late-luteal': ["Let's have a super-chill movie marathon with all the best comfort food.", "How about I take care of everything tonight so you can just relax?", "A quiet evening with a good book and a cup of tea sounds like the perfect plan."],
                    default: ["How about we just order some food and watch a movie?"]
                }
            };
            
            if (tone === 'dude_mode') {
                const dudeRecs = aiGeneratedResponses.dude_mode[phaseClassKey] || [aiGeneratedResponses.dude_mode.default];
                recommendationTextDiv.textContent = dudeRecs[Math.floor(Math.random() * dudeRecs.length)];
            } else {
                recommendationTextDiv.textContent = staticRecommendations[phaseClassKey]?.[tone] || staticRecommendations.default.easygoing;
            }
        }

        function updateOutlookDateDisplay() { 
            const daysFromToday = parseInt(outlookDateSlider.value);
            const targetDate = addDays(new Date(), daysFromToday);
            outlookDateDisplay.textContent = daysFromToday === 0 ? `Today (${formatDate(targetDate)})` : formatDate(targetDate);
        }
        
        function updateSetupAvatarPreview() {
            const tempAvatarConfig = {
                faceShape: faceShapeSelect.value, skinTone: skinToneInput.value,
                eyeColor: eyeColorInput.value, eyeShape: eyeShapeSelect.value,
                lipShape: lipShapeSelect.value
            };
            const neutralMood = { 
                eyeType: 'normal', mouthType: 'neutral', eyebrowType: 'normal', 
                lipColor: "#D87093", expressionLineColor: "#4B5563" 
            };
            avatarPreviewSetupDiv.innerHTML = getFaceSVG(tempAvatarConfig, neutralMood);
        }

        function findAllPhaseDateOffsetsInRange(targetPhaseKey, rangeStartOffset, rangeEndOffset) {
            if (!currentLmpDate) return [];
            const offsets = [];
            let today = new Date();
            today.setHours(0,0,0,0); 

            for (let i = rangeStartOffset; i <= rangeEndOffset; i++) {
                const futureDate = addDays(today, i);
                const futureDateUTC = new Date(Date.UTC(futureDate.getFullYear(), futureDate.getMonth(), futureDate.getDate()));
                const lmpDateUTC = new Date(Date.UTC(currentLmpDate.getFullYear(), currentLmpDate.getMonth(), currentLmpDate.getDate()));

                if (futureDateUTC < lmpDateUTC) continue;

                const diffTime = futureDateUTC.getTime() - lmpDateUTC.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                const cycleLength = 28;
                let cycleDay = diffDays % cycleLength;
                if (cycleDay === 0) cycleDay = cycleLength;

                let phaseKeyForDay = 'default';
                if (cycleDay >= 1 && cycleDay <= 4) phaseKeyForDay = 'menstruation';
                else if (cycleDay >= 5 && cycleDay <= 9) phaseKeyForDay = 'follicular';
                else if (cycleDay >= 10 && cycleDay <= 12) phaseKeyForDay = 'late-follicular';
                else if (cycleDay >= 13 && cycleDay <= 15) phaseKeyForDay = 'ovulation'; 
                else if (cycleDay >= 16 && cycleDay <= 19) phaseKeyForDay = 'early-luteal';
                else if (cycleDay >= 20 && cycleDay <= 23) phaseKeyForDay = 'mid-luteal';
                else if (cycleDay >= 24 && cycleDay <= 28) phaseKeyForDay = 'late-luteal'; 

                if (phaseKeyForDay === targetPhaseKey) {
                    offsets.push(i); 
                }
            }
            return offsets;
        }

        function displaySliderHighlights(offsets, color, highlightGroupId) {
            clearSliderHighlights(highlightGroupId); 
            const sliderMax = parseInt(outlookDateSlider.max);
            const sliderMin = parseInt(outlookDateSlider.min);
            const sliderWidth = outlookDateSlider.offsetWidth; 
            const PADDING = 10; 

            offsets.forEach(offset => {
                if (offset >= sliderMin && offset <= sliderMax) {
                    const marker = document.createElement('div');
                    marker.classList.add('highlight-marker');
                    marker.dataset.highlightGroup = highlightGroupId; 
                    marker.style.backgroundColor = color;
                    
                    const percentPosition = ((offset - sliderMin) / (sliderMax - sliderMin)) * 100;
                    const effectiveTrackWidth = sliderWidth - (2 * PADDING);
                    const leftPosition = PADDING + (percentPosition / 100) * effectiveTrackWidth;
                    
                    marker.style.left = `${leftPosition - 2}px`; 
                    marker.style.width = '4px'; 
                    
                    sliderHighlightTrack.appendChild(marker);
                }
            });
        }

        function clearSliderHighlights(highlightGroupId = null) {
            const markers = sliderHighlightTrack.querySelectorAll('.highlight-marker');
            markers.forEach(marker => {
                if (!highlightGroupId || marker.dataset.highlightGroup === highlightGroupId) {
                    marker.remove();
                }
            });
        }
        
        function updateSuggestionCheckboxesVisibility() {
            if (currentSuggestionTone === 'dude_mode') { 
                suggestionCheckboxesContainer.classList.remove('hidden');
            } else {
                suggestionCheckboxesContainer.classList.add('hidden');
                if (dinnerDateCheckbox.checked) {
                    dinnerDateCheckbox.checked = false;
                    clearSliderHighlights('dinnerDate');
                }
                if (bizTripCheckbox.checked) { 
                    bizTripCheckbox.checked = false;
                    clearSliderHighlights('bizTrip');
                }
                if(lazySundaysCheckbox.checked) {
                    lazySundaysCheckbox.checked = false;
                    clearSliderHighlights('lazySundays');
                }
            }
        }


        function updateOutlook() {
            if (!currentLmpDate) {
                const initialMood = { eyeType:'normal', mouthType:'neutral', eyebrowType:'normal', lipColor: "#D87093", expressionLineColor: "#4B5563"};
                outputSection.className = 'card text-center p-3';
                smallThermometerDisplay.innerHTML = `<div class="small-thermometer-icon"><div class="small-thermometer-fill default-fill" style="height: 10%;"></div><div class="small-thermometer-bulb default-fill"></div></div>`;
                avatarDisplay.innerHTML = getFaceSVG(currentAvatarConfig, initialMood);
                phaseIconDisplay.innerHTML = cyclePhaseIcons.default;
                moodTextDisplay.innerHTML = `<p class="text-slate-500 text-lg mt-2">Complete setup first.</p>`;
                userInfoHeaderDiv.innerHTML = `<p>Welcome to Hermometer!</p>`;
                recommendationTextDiv.textContent = "Complete setup to see tips.";
                updateGraphIndicator(1); 
                updateSmallThermometerVisual('default', 1);
                updateSuggestionCheckboxesVisibility(); 
                return;
            }

            const outlookDaysOffset = parseInt(outlookDateSlider.value);
            updateOutlookDateDisplay(); 

            const baseOutlookDate = addDays(new Date(), outlookDaysOffset);
            const baseOutlookDateUTC = new Date(Date.UTC(baseOutlookDate.getFullYear(), baseOutlookDate.getMonth(), baseOutlookDate.getDate()));
            const finalDateToCalc = baseOutlookDateUTC; 
            const lmpDateUTC = new Date(Date.UTC(currentLmpDate.getFullYear(), currentLmpDate.getMonth(), currentLmpDate.getDate()));

            if (finalDateToCalc < lmpDateUTC) {
                const errorMood = { eyeType: 'sensitive', mouthType: 'sad', eyebrowType: 'furrowed', lipColor: "#D87093", expressionLineColor: currentAvatarConfig.eyeColor };
                outputSection.className = 'card text-center p-3 default-bg';
                smallThermometerDisplay.innerHTML = `<div class="small-thermometer-icon"><div class="small-thermometer-fill default-fill" style="height: 10%;"></div><div class="small-thermometer-bulb default-fill"></div></div>`;
                avatarDisplay.innerHTML = getFaceSVG(currentAvatarConfig, errorMood);
                phaseIconDisplay.innerHTML = cyclePhaseIcons.default;
                moodTextDisplay.innerHTML = `<p class="text-slate-500 text-lg mt-2">Outlook date cannot be before LMP.</p>`;
                userInfoHeaderDiv.innerHTML = `<p class="user-name">Outlook for ${currentPartnerName}</p><p>Invalid Date Selection</p>`;
                recommendationTextDiv.textContent = "Please select a date on or after the LMP.";
                updateGraphIndicator(1);
                updateSmallThermometerVisual('default', 1);
                updateSuggestionCheckboxesVisibility();
                return;
            }

            const diffTime = finalDateToCalc.getTime() - lmpDateUTC.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            const cycleLength = 28;
            let currentCycleDay = diffDays % cycleLength;
            if (currentCycleDay === 0) currentCycleDay = cycleLength;

            userInfoHeaderDiv.innerHTML = `<p><span class="user-name">Outlook for ${currentPartnerName}</span></p><p>Cycle Day: ${currentCycleDay} (on ${formatDate(finalDateToCalc)})</p>`;

            let phaseName = "Unknown", moodDescriptor = "Neutral", 
                moodExpressions = { eyeType: "normal", mouthType: "neutral", eyebrowType: "normal", lipColor: "#D87093", expressionLineColor: "#4B5563" }, 
                phaseClass = "default", phaseClassKey = 'default';

            const defaultExpressionColor = currentAvatarConfig.eyeColor ? currentAvatarConfig.eyeColor : "#4B5563"; 
            const defaultLipColor = "#E58C93"; 

            if (currentCycleDay >= 1 && currentCycleDay <= 4) {
                phaseName = "Menstruation"; moodDescriptor = "Rest & Recharge"; 
                moodExpressions = { eyeType: "sleepy", mouthType: "neutral", eyebrowType: "normal", lipColor: defaultLipColor, expressionLineColor: defaultExpressionColor }; 
                phaseClass = "menstruation"; phaseClassKey = 'menstruation';
            } else if (currentCycleDay >= 5 && currentCycleDay <= 9) {
                phaseName = "Follicular Phase"; moodDescriptor = "Energy Building"; 
                moodExpressions = { eyeType: "normal", mouthType: "smile", eyebrowType: "normal", lipColor: defaultLipColor, expressionLineColor: defaultExpressionColor };
                phaseClass = "follicular"; phaseClassKey = 'follicular';
            } else if (currentCycleDay >= 10 && currentCycleDay <= 12) {
                phaseName = "Late Follicular"; moodDescriptor = "Approaching Peak";
                moodExpressions = { eyeType: "normal", mouthType: "smile", eyebrowType: "raised", lipColor: "#F06292", expressionLineColor: defaultExpressionColor };
                phaseClass = "late-follicular"; phaseClassKey = 'late-follicular';
            } else if (currentCycleDay >= 13 && currentCycleDay <= 15) {
                phaseName = "Ovulation Window"; moodDescriptor = "Peak Energy & Flirty"; 
                moodExpressions = { eyeType: "sparkle", mouthType: "flirty", eyebrowType: "raised", lipColor: "#F06292", expressionLineColor: defaultExpressionColor }; 
                phaseClass = "ovulation"; phaseClassKey = 'ovulation';
            } else if (currentCycleDay >= 16 && currentCycleDay <= 19) {
                phaseName = "Early Luteal Phase"; moodDescriptor = "Post-Peak Calm"; 
                moodExpressions = { eyeType: "normal", mouthType: "neutral", eyebrowType: "normal", lipColor: defaultLipColor, expressionLineColor: defaultExpressionColor };
                phaseClass = "early-luteal"; phaseClassKey = 'early-luteal';
            } else if (currentCycleDay >= 20 && currentCycleDay <= 23) {
                phaseName = "Mid-Luteal Phase"; moodDescriptor = "Winding Down";
                moodExpressions = { eyeType: "normal", mouthType: "neutral", eyebrowType: "normal", lipColor: "#D37584", expressionLineColor: defaultExpressionColor };
                phaseClass = "mid-luteal"; phaseClassKey = 'mid-luteal';
            } else if (currentCycleDay >= 24 && currentCycleDay <= 28) {
                phaseName = "Late Luteal (PMS)"; moodDescriptor = "Potential Sensitivity"; 
                moodExpressions = { eyeType: "sensitive", mouthType: "sad", eyebrowType: "furrowed", lipColor: "#D37584", expressionLineColor: defaultExpressionColor }; 
                phaseClass = "late-luteal"; phaseClassKey = 'late-luteal';
            }
            
            outputSection.className = `card text-center p-3 ${phaseClass}-bg`;
            smallThermometerDisplay.innerHTML = `<div class="small-thermometer-icon"><div class="small-thermometer-fill"></div><div class="small-thermometer-bulb"></div></div>`; 
            avatarDisplay.innerHTML = getFaceSVG(currentAvatarConfig, moodExpressions);
            phaseIconDisplay.innerHTML = cyclePhaseIcons[phaseClassKey] || cyclePhaseIcons.default;
            phaseIconDisplay.firstElementChild?.setAttribute('class', `${phaseClass}-text`); 
            moodTextDisplay.innerHTML = `<h2 class="text-xl font-semibold ${phaseClass}-text mb-0.5">${moodDescriptor}</h2><p class="text-sm ${phaseClass}-text opacity-80">${phaseName}</p>`;
            
            getRecommendation(phaseClassKey, currentSuggestionTone);
            updateGraphIndicator(currentCycleDay);
            updateSmallThermometerVisual(phaseClassKey, currentCycleDay);
            updateSuggestionCheckboxesVisibility();
        }

        function generateDateIdea() {
            if (!currentLmpDate) return;
            const outlookDaysOffset = parseInt(outlookDateSlider.value);
            const baseOutlookDate = addDays(new Date(), outlookDaysOffset);
            const baseOutlookDateUTC = new Date(Date.UTC(baseOutlookDate.getFullYear(), baseOutlookDate.getMonth(), baseOutlookDate.getDate()));
            const lmpDateUTC = new Date(Date.UTC(currentLmpDate.getFullYear(), currentLmpDate.getMonth(), currentLmpDate.getDate()));
            const diffTime = baseOutlookDateUTC.getTime() - lmpDateUTC.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            const cycleLength = 28;
            let currentCycleDay = diffDays % cycleLength;
            if (currentCycleDay === 0) currentCycleDay = cycleLength;

            let phaseKey = 'default';
            if (currentCycleDay >= 1 && currentCycleDay <= 4) { phaseKey = "menstruation"; }
            else if (currentCycleDay >= 5 && currentCycleDay <= 9) { phaseKey = "follicular"; }
            else if (currentCycleDay >= 10 && currentCycleDay <= 12) { phaseKey = "late-follicular"; }
            else if (currentCycleDay >= 13 && currentCycleDay <= 15) { phaseKey = "ovulation"; }
            else if (currentCycleDay >= 16 && currentCycleDay <= 19) { phaseKey = "early-luteal"; }
            else if (currentCycleDay >= 20 && currentCycleDay <= 23) { phaseKey = "mid-luteal"; }
            else if (currentCycleDay >= 24 && currentCycleDay <= 28) { phaseKey = "late-luteal"; }

            const ideas = aiGeneratedResponses.dateIdeas[phaseKey];
            const idea = ideas[Math.floor(Math.random() * ideas.length)];

            dateIdeaText.textContent = idea;
            dateIdeaModal.classList.remove('hidden');
        }

        startTrackingBtn.addEventListener('click', () => { 
            const name = partnerNameInput.value.trim(); 
            const lmpString = lmpDateSetupInput.value; 
            
            currentAvatarConfig = {faceShape: faceShapeSelect.value, skinTone: skinToneInput.value, eyeColor: eyeColorInput.value, eyeShape: eyeShapeSelect.value, lipShape: lipShapeSelect.value};
            
            if (!name || !lmpString) { alert("Please enter your partner's name and her LMP date."); return; }
            const lmpParts = lmpString.split('-'); const lmp = new Date(Date.UTC(parseInt(lmpParts[0]), parseInt(lmpParts[1]) - 1, parseInt(lmpParts[2])));
            if (isNaN(lmp.getTime())) { alert("Invalid LMP date format."); return; }
            const todayUTC = new Date(Date.UTC(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()));
            if (lmp > todayUTC) { alert("LMP date cannot be in the future."); return; }
            currentPartnerName = name; currentLmpDate = lmp; 
            
            localStorage.setItem('hermometerPartnerName', currentPartnerName); 
            localStorage.setItem('hermometerLmpDate', currentLmpDate.toISOString()); 
            localStorage.setItem('hermometerAvatarConfig', JSON.stringify(currentAvatarConfig));
            
            mainSuggestionToneSelect.value = "easygoing"; 
            localStorage.setItem('hermometerSuggestionTone', "easygoing");

            appIconDisplay.innerHTML = empathyWaveIconSVG; 

            setupScreen.classList.add('hidden'); mainScreen.classList.remove('hidden');
            drawHormoneGraphBase(); updateOutlook();
        });
        
        resetSetupBtn.addEventListener('click', () => { 
            mainScreen.classList.add('hidden'); setupScreen.classList.remove('hidden');
            partnerNameInput.value = currentPartnerName; lmpDateSetupInput.value = currentLmpDate ? currentLmpDate.toISOString().split('T')[0] : ''; 
            faceShapeSelect.value = currentAvatarConfig.faceShape; skinToneInput.value = currentAvatarConfig.skinTone; eyeColorInput.value = currentAvatarConfig.eyeColor; eyeShapeSelect.value = currentAvatarConfig.eyeShape; lipShapeSelect.value = currentAvatarConfig.lipShape;
            
            updateSetupAvatarPreview(); 
        });

        outlookDateSlider.addEventListener('input', updateOutlook);
        
        dinnerDateCheckbox.addEventListener('change', function() {
            if (this.checked) {
                if(bizTripCheckbox.checked) { bizTripCheckbox.checked = false; clearSliderHighlights('bizTrip'); }
                if(lazySundaysCheckbox.checked) { lazySundaysCheckbox.checked = false; clearSliderHighlights('lazySundays'); }
                const offsets = findAllPhaseDateOffsetsInRange('ovulation', 0, parseInt(outlookDateSlider.max));
                console.log('Dinner date (ovulation) offsets:', offsets); 
                displaySliderHighlights(offsets, 'rgba(227, 124, 153, 0.7)', 'dinnerDate'); 
            } else {
                clearSliderHighlights('dinnerDate');
            }
        });

        bizTripCheckbox.addEventListener('change', function() {
            if (this.checked) {
                 if(dinnerDateCheckbox.checked) { dinnerDateCheckbox.checked = false; clearSliderHighlights('dinnerDate'); }
                 if(lazySundaysCheckbox.checked) { lazySundaysCheckbox.checked = false; clearSliderHighlights('lazySundays'); }
                const offsets = findAllPhaseDateOffsetsInRange('late-luteal', 0, parseInt(outlookDateSlider.max));
                console.log('Biz trip (late-luteal) offsets:', offsets); 
                displaySliderHighlights(offsets, 'rgba(217, 142, 97, 0.7)', 'bizTrip'); 
            } else {
                clearSliderHighlights('bizTrip');
            }
        });

        lazySundaysCheckbox.addEventListener('change', function() {
            if (this.checked) {
                if(dinnerDateCheckbox.checked) { dinnerDateCheckbox.checked = false; clearSliderHighlights('dinnerDate'); }
                if(bizTripCheckbox.checked) { bizTripCheckbox.checked = false; clearSliderHighlights('bizTrip'); }
                const offsets = findAllPhaseDateOffsetsInRange('menstruation', 0, parseInt(outlookDateSlider.max));
                console.log('Lazy Sunday (menstruation) offsets:', offsets);
                displaySliderHighlights(offsets, 'rgba(106, 127, 219, 0.7)', 'lazySundays');
            } else {
                clearSliderHighlights('lazySundays');
            }
        });

        [faceShapeSelect, skinToneInput, eyeColorInput, eyeShapeSelect, lipShapeSelect].forEach(el => {
            el.addEventListener('input', updateSetupAvatarPreview);
            el.addEventListener('change', updateSetupAvatarPreview); 
        });
        
        mainSuggestionToneSelect.addEventListener('change', () => { 
            currentSuggestionTone = mainSuggestionToneSelect.value; 
            localStorage.setItem('hermometerSuggestionTone', currentSuggestionTone); 
            updateOutlook(); 
        });

        getDateIdeaBtn.addEventListener('click', generateDateIdea);
        closeDateIdeaModal.addEventListener('click', () => dateIdeaModal.classList.add('hidden'));

        if(resetAppBtn) {
            resetAppBtn.addEventListener('click', () => {
                confirmResetModal.classList.remove('hidden');
            });
        }
        
        cancelResetBtn.addEventListener('click', () => {
            confirmResetModal.classList.add('hidden');
        });

        confirmResetBtn.addEventListener('click', () => {
            localStorage.clear(); 
            location.reload();
        });


        function initializeApp() { 
            const hasWelcomed = localStorage.getItem('hermometer_has_welcomed');

            if (!hasWelcomed) {
                welcomeScreen.classList.remove('hidden');
                welcomeArtwork.innerHTML = welcomeArtworkSVG;
                return; 
            }
            
            loadMainApp();
        }

        function loadMainApp() {
            welcomeScreen.classList.add('hidden'); 

            const savedName = localStorage.getItem('hermometerPartnerName'); 
            const savedLmpString = localStorage.getItem('hermometerLmpDate'); 
            const savedTone = localStorage.getItem('hermometerSuggestionTone'); 
            const savedAvatarConfigString = localStorage.getItem('hermometerAvatarConfig');
            
            currentSuggestionTone = savedTone || 'easygoing'; 

            if (savedName && savedLmpString) {
                currentPartnerName = savedName; 
                currentLmpDate = new Date(savedLmpString); 
                if (savedAvatarConfigString) { currentAvatarConfig = JSON.parse(savedAvatarConfigString); }
                partnerNameInput.value = currentPartnerName; 
                lmpDateSetupInput.value = currentLmpDate.toISOString().split('T')[0]; 
                mainSuggestionToneSelect.value = currentSuggestionTone; 
                
                faceShapeSelect.value = currentAvatarConfig.faceShape || 'oval'; skinToneInput.value = currentAvatarConfig.skinTone || '#F0C0A0'; eyeColorInput.value = currentAvatarConfig.eyeColor || '#5080C0'; eyeShapeSelect.value = currentAvatarConfig.eyeShape || 'almond'; lipShapeSelect.value = currentAvatarConfig.lipShape || 'natural';
                
                setupScreen.classList.add('hidden'); 
                mainScreen.classList.remove('hidden');
                drawHormoneGraphBase(); 
            } else {
                setupScreen.classList.remove('hidden'); 
                mainScreen.classList.add('hidden');
            }
            if (!lmpDateSetupInput.value) { const twoWeeksAgo = addDays(new Date(), -14); lmpDateSetupInput.value = twoWeeksAgo.toISOString().split('T')[0]; }
            
            appIconDisplay.innerHTML = empathyWaveIconSVG; 
            
            updateSetupAvatarPreview(); 
            updateOutlook(); 
        }
        
        proceedToSetupBtn.addEventListener('click', () => {
            localStorage.setItem('hermometer_has_welcomed', 'true');
            loadMainApp();
        });

        initializeApp();
    </script>
</body>
</html>
